!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3-request"),require("d3-queue"),require("solarnetwork-api-core")):"function"==typeof define&&define.amd?define(["exports","d3-request","d3-queue","solarnetwork-api-core"],t):t(e.sn=e.sn||{},e.d3,e.d3,e.sn)}(this,function(e,t,i,n){"use strict";function r(e){var t,i,r=0;for(r=0;r<e.length;r+=1)void 0!==(i=e[r]).data&&void 0!==i.data.endDate?(i=i.data,void 0===t?t=i:(i.endDateMillis>t.endDateMillis&&(t.endDateMillis=i.endDateMillis,t.endDate=i.endDate),i.startDateMillis<t.startDateMillis&&(t.startDateMillis=i.startDateMillis,t.startDate=i.startDate))):n.Logger.debug("No data available for %s sources %s",this._helpers[r].nodeId,this._helpers[r].sourceIds.join(","));return t}function a(e){if(!0===e.success&&void 0!==e.data&&!0===Array.isArray(e.data.results))return e.data.results}function s(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount:0}function o(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount+t.startingOffset:0}var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},d=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),f=function(){function e(i,r){u(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this._helpers=Array.isArray(i)?i:i?[i]:[new n.NodeDatumUrlHelper],this.authBuilder=r,this.jsonClient=t.json}return d(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"do",value:function(){var e=this;return new Promise(function(t,i){e.exec(function(e,n){e?i(e):t(n)})})}},{key:"exec",value:function(e){var t=i.queue(),a=this.jsonClient,s=this.authBuilder,o=!0,l=!1,u=void 0;try{for(var d,f=this._helpers[Symbol.iterator]();!(o=(d=f.next()).done);o=!0)!function(e){var i=e.reportableIntervalUrl(),r=a(i);s&&r.on("beforesend",function(e){s.reset().snDate(!0).url(i),e.setRequestHeader(n.HttpHeaders.X_SN_DATE,s.requestDateHeaderValue),e.setRequestHeader(n.HttpHeaders.AUTHORIZATION,s.buildWithSavedKey())}),t.defer(r.get,null)}(d.value)}catch(e){l=!0,u=e}finally{try{!o&&f.return&&f.return()}finally{if(l)throw u}}t.awaitAll(function(t,i){if(t)return n.Logger.error("Error requesting available data range: %s",t),void("function"==typeof e&&e(t));var a=r(i);void 0!==a.startDateMillis&&(a.sDate=new Date(a.startDateMillis)),void 0!==a.endDateMillis&&(a.eDate=new Date(a.endDateMillis)),"function"==typeof e&&e(null,a)})}}]),e}(),c=function(){function e(i,r,a){u(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this.urlHelper=i||new n.NodeDatumUrlHelper,this.filter=r||new n.DatumFilter({nodeIds:this.urlHelper.nodeIds}),this.authBuilder=a,this._finishedCallback=void 0,this._urlParameters=void 0,this.jsonClient=t.json,this._incrementalMode=!1,this._state=0,this._results=void 0}return d(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}},{key:"parameters",value:function(e){return e?("object"===(void 0===e?"undefined":l(e))&&(this._urlParameters=e),this):this._urlParameters}},{key:"incremental",value:function(e){return void 0===e?this._incrementalMode:(this._incrementalMode=!!e,this)}},{key:"load",value:function(e){return"function"==typeof e&&(this._finishedCallback=e),this._state=1,this.loadData(),this}},{key:"handleResults",value:function(e,t,i){if(t&&(this._state=2),this._finishedCallback){var n=[e,this._results];this._incrementalMode&&(n.push(t),n.push(i)),this._finishedCallback.apply(this,n)}}},{key:"loadData",value:function(e){var t=this,i=e instanceof n.Pagination?e:new n.Pagination,r=this.urlHelper.listDatumUrl(this.filter,void 0,i);if(this._urlParameters){var l=n.urlQuery.urlQueryEncode(this._urlParameters);l&&(r+="&"+l)}var u=this.authBuilder;this.jsonClient(r).on("beforesend",function(e){u&&(u.reset().snDate(!0).url(r),e.setRequestHeader(n.HttpHeaders.X_SN_DATE,u.requestDateHeaderValue),e.setRequestHeader(n.HttpHeaders.AUTHORIZATION,u.buildWithSavedKey()))}).on("load",function(e){var l=a(e);if(void 0===l)return n.Logger.debug("No data available for %s",r),void t.handleResults();var u=t._incrementalMode,d=o(e);if(void 0===t._results||u){if(t._results=l,i.max<1){var f=s(e);f>0&&(i=new n.Pagination(f,i.offset))}u&&t.handleResults(void 0,d<1,i)}else t._results=t._results.concat(l);d>0?t.loadData(i.withOffset(d)):u||t.handleResults(void 0,!0)}).on("error",function(e){n.Logger.error("Error requesting data for %s: %s",r,e),t.handleResults(new Error("Error requesting data for "+r+": "+e))}).get()}}]),e}(),h=function(){function e(t){u(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this._loaders=t,this._finishedCallback=void 0}return d(e,[{key:"load",value:function(e){var t=this;"function"==typeof e&&(this._finishedCallback=e);var n=i.queue();return this._loaders.forEach(function(e){n.defer(function(t){e.load(t)})}),n.awaitAll(function(e,i){t._finishedCallback&&t._finishedCallback.call(t,e,i)}),this}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}}]),e}();e.DatumRangeFinder=f,e.DatumLoader=c,e.MultiLoader=h,Object.defineProperty(e,"__esModule",{value:!0})});