!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3-queue"),require("solarnetwork-api-core"),require("d3-request")):"function"==typeof define&&define.amd?define(["exports","d3-queue","solarnetwork-api-core","d3-request"],t):(e=e||self,t(e.sn={},e.d3,e.sn,e.d3))}(this,function(e,t,r,n){"use strict";function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?c(e):t}function h(e){var t,n,i=0;for(i=0;i<e.length;i+=1)void 0!==(n=e[i]).data&&void 0!==n.data.endDate?(n=n.data,void 0===t?t=n:(n.endDateMillis>t.endDateMillis&&(t.endDateMillis=n.endDateMillis,t.endDate=n.endDate),n.startDateMillis<t.startDateMillis&&(t.startDateMillis=n.startDateMillis,t.startDate=n.startDate))):r.Logger.debug("No data available for %s sources %s",this._helpers[i].nodeId,this._helpers[i].sourceIds.join(","));return t}function v(e){if(!0===e.success&&void 0!==e.data&&!0===Array.isArray(e.data.results))return e.data.results}function y(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount:0}function p(e,t){var r=e.data;return t&&t.max?r.returnedResultCount<t.max?0:r.startingOffset+t.max:r.returnedResultCount+r.startingOffset<r.totalResults?r.returnedResultCount+r.startingOffset:0}var _=function(){function e(t){a(this,e),this.authBuilder=t,this.jsonClient=n.json}return u(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,n){e?r(e):t(n)})})}},{key:"load",value:function(e){e(new Error("Abstract method must be implemented by subclass."))}}]),e}(),b=function(e){function n(e,t){var i;return a(this,n),i=f(this,s(n).call(this,t)),Object.defineProperties(c(i),{version:{value:"1.0.0"}}),i._helpers=Array.isArray(e)?e:e?[e]:[new r.NodeDatumUrlHelper],i}return l(n,_),u(n,[{key:"load",value:function(e){var n=t.queue(),i=this.client(),a=this.authBuilder,o=!0,u=!1,l=void 0;try{for(var s,d=function(){var e=s.value.reportableIntervalUrl(),t=i(e).on("beforesend",function(t){a&&a.signingKeyValid&&(a.reset().snDate(!0).url(e,!0),t.setRequestHeader(r.HttpHeaders.X_SN_DATE,a.requestDateHeaderValue),t.setRequestHeader(r.HttpHeaders.AUTHORIZATION,a.buildWithSavedKey()))});n.defer(t.get,null)},c=this._helpers[Symbol.iterator]();!(o=(s=c.next()).done);o=!0)d()}catch(e){u=!0,l=e}finally{try{o||null==c.return||c.return()}finally{if(u)throw l}}n.awaitAll(function(t,n){if(t)return r.Logger.error("Error requesting available data range: %s",t),void("function"==typeof e&&e(t));var i=h(n);void 0!==i.startDateMillis&&(i.sDate=new Date(i.startDateMillis)),void 0!==i.endDateMillis&&(i.eDate=new Date(i.endDateMillis)),"function"==typeof e&&e(null,i)})}}]),n}(),m=function(e){function n(e,t){var i;return a(this,n),i=f(this,s(n).call(this,t)),Object.defineProperties(c(i),{version:{value:"1.0.0"}}),i._helpers=Array.isArray(e)?e:e?[e]:[new r.NodeDatumUrlHelper],i}return l(n,_),u(n,[{key:"filter",value:function(e){return e?(e instanceof r.DatumFilter&&(this.datumFilter=e),this):this.datumFilter}},{key:"load",value:function(e){function n(e,t){u.push(e);var n=a(t).on("beforesend",function(e){o&&o.signingKeyValid&&(o.reset().snDate(!0).url(t,!0),e.setRequestHeader(r.HttpHeaders.X_SN_DATE,o.requestDateHeaderValue),e.setRequestHeader(r.HttpHeaders.AUTHORIZATION,o.buildWithSavedKey()))});i.defer(n.get,null)}var i=t.queue(),a=this.client(),o=this.authBuilder,u=[],l=!0,s=!1,d=void 0;try{for(var c,f=this._helpers[Symbol.iterator]();!(l=(c=f.next()).done);l=!0){var h=c.value,v=new r.DatumFilter(this.datumFilter);if(v.nodeIds=h.nodeIds,v.metadataFilter||1===v.nodeIds.length)n(this.metadataFilter?null:v.nodeId,h.availableSourcesUrl(v));else{var y=!0,p=!1,_=void 0;try{for(var b,m=v.nodeIds[Symbol.iterator]();!(y=(b=m.next()).done);y=!0){var g=b.value,D=new r.DatumFilter(v);D.nodeId=g,n(g,h.availableSourcesUrl(D))}}catch(e){p=!0,_=e}finally{try{y||null==m.return||m.return()}finally{if(p)throw _}}}}}catch(e){s=!0,d=e}finally{try{l||null==f.return||f.return()}finally{if(s)throw d}}i.awaitAll(function(t,n){if(t)return r.Logger.error("Error requesting available sources: %s",t),void("function"==typeof e&&e(t));for(var i={},a=0,o=n.length;a<o;a+=1){var l=Array.isArray(n[a].data)?n[a].data:void 0;if(l){var s=u[a];if(null===s){var d=!0,c=!1,f=void 0;try{for(var h,v=l[Symbol.iterator]();!(d=(h=v.next()).done);d=!0){var y=h.value,p=i[y.nodeId];p||(p=[],i[y.nodeId]=p),p.indexOf(y.sourceId)<0&&p.push(y.sourceId)}}catch(e){c=!0,f=e}finally{try{d||null==v.return||v.return()}finally{if(c)throw f}}}else{var _=i[s];if(_){var b=!0,m=!1,g=void 0;try{for(var D,w=l[Symbol.iterator]();!(b=(D=w.next()).done);b=!0){var k=D.value;_.indexOf(k)<0&&_.push(k)}}catch(e){m=!0,g=e}finally{try{b||null==w.return||w.return()}finally{if(m)throw g}}}else i[s]=l}}}"function"==typeof e&&e(null,i)})}}]),n}(),g=function(e){function n(e,t,i){var o;return a(this,n),o=f(this,s(n).call(this,i)),Object.defineProperties(c(o),{version:{value:"1.2.0"}}),o.urlHelper=e||new r.NodeDatumUrlHelper,i||(e.publicQuery=!0),o.filter=t||new r.DatumFilter({nodeIds:o.urlHelper.nodeIds,withoutTotalResultsCount:!0}),o._pageSize=1e3,o._includeTotalResultsCount=!1,o._finishedCallback=void 0,o._urlParameters=void 0,o._incrementalMode=!1,o._readingsMode=!1,o._proxyUrl=void 0,o._concurrency=0,o._queue=null,o._state=0,o._results=void 0,o}return l(n,_),u(n,[{key:"concurrency",value:function(e){return void 0===e?this._concurrency:(!isNaN(e)&&Number(e)>0&&(this._concurrency=Number(e)),this)}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}},{key:"parameters",value:function(e){return e?("object"===i(e)&&(this._urlParameters=e),this):this._urlParameters}},{key:"incremental",value:function(e){return void 0===e?this._incrementalMode:(this._incrementalMode=!!e,this)}},{key:"paginationSize",value:function(e){return isNaN(Number(e))?this._pageSize:(this._pageSize=e,this)}},{key:"includeTotalResultsCount",value:function(e){return void 0===e?this._includeTotalResultsCount:(this._includeTotalResultsCount=!!e,this)}},{key:"readings",value:function(e){return void 0===e?this._readingsMode:(this._readingsMode=!!e,this)}},{key:"proxyUrl",value:function(e){return void 0===e?this._proxyUrl:(this._proxyUrl=e||void 0,this)}},{key:"load",value:function(e){return"function"==typeof e&&(this._finishedCallback=e),this._state=1,this._concurrency>0&&(this._queue=t.queue(this._concurrency===1/0?null:this._concurrency)),this.loadData(new r.Pagination(this._pageSize,0)),this}},{key:"handleResults",value:function(e,t,r){if(t&&(this._state=2),this._finishedCallback){var n=[e,this._results];this._incrementalMode&&(n.push(t),n.push(r)),this._finishedCallback.apply(this,n)}}},{key:"loadData",value:function(e){var t=this,n=this.authBuilder,i=this._queue,a=e instanceof r.Pagination?e:new r.Pagination,o=new r.DatumFilter(this.filter);o.withoutTotalResultsCount=!this._includeTotalResultsCount&&!i||0!==a.offset;var u=this._readingsMode?this.urlHelper.datumReadingUrl(o,r.DatumReadingTypes.Difference,void 0,void 0,a):this.urlHelper.listDatumUrl(o,void 0,a);if(this._urlParameters){var l=r.urlQuery.urlQueryEncode(this._urlParameters);l&&(u+="&"+l)}var s=this._proxyUrl?u.replace(/^[^:]+:\/\/[^/]+/,this._proxyUrl):u,d=this.client()(s).on("beforesend",function(e){n&&n.signingKeyValid&&(n.reset().snDate(!0).url(u,!0),e.setRequestHeader(r.HttpHeaders.X_SN_DATE,n.requestDateHeaderValue),e.setRequestHeader(r.HttpHeaders.AUTHORIZATION,n.buildWithSavedKey()))}).on("load",function(e){var n=v(e);if(void 0===n)return r.Logger.debug("No data available for %s",s),void t.handleResults();var o=t._incrementalMode,u=p(e,a),l=e.data?e.data.totalResults:null;if(void 0===t._results||o){if(t._results=n,a.max<1){var d=y(e);d>0&&(a=new r.Pagination(d,a.offset))}o&&t.handleResults(void 0,u<1,a)}else i||(t._results=t._results.concat(n));if(u>0||i&&a.offset>0)if(i){if(l>0){for(var c=u;c<l;c+=a.max)t.loadData(a.withOffset(c));i.awaitAll(function(e,r){e||r.map(function(e){return v(e)||[]}).forEach(function(e){t._results=t._results.concat(e)}),t.handleResults(null!==e?e:void 0,!0)})}}else t.loadData(a.withOffset(u));else o||t.handleResults(void 0,!0)}).on("error",function(e){r.Logger.error("Error requesting data for %s: %s",s,e),t.handleResults(new Error("Error requesting data for ".concat(s,": ").concat(e)))});i&&a.offset>0?i.defer(d.get,null):d.get()}}]),n}(),D=function(){function e(t){a(this,e),Object.defineProperties(this,{version:{value:"1.1.0"}}),this._loaders=t,this._finishedCallback=void 0,this._concurrency=1/0}return u(e,[{key:"concurrency",value:function(e){if(void 0===e)return this._concurrency;var t=Number(e);return!isNaN(e)&&t>0&&(this._concurrency=t),this}},{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,n){e?r(e):t(n)})})}},{key:"load",value:function(e){var r=this;"function"==typeof e&&(this._finishedCallback=e);var n=t.queue(this._concurrency);return this._loaders.forEach(function(e){n.defer(e.load.bind(e))}),n.awaitAll(function(e,t){r._finishedCallback&&r._finishedCallback.call(r,e,t)}),this}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}}]),e}();e.DatumLoader=g,e.DatumRangeFinder=b,e.DatumSourceFinder=m,e.MultiLoader=D,Object.defineProperty(e,"__esModule",{value:!0})});