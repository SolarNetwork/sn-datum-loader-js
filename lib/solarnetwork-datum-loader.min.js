!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3-queue"),require("solarnetwork-api-core"),require("d3-request")):"function"==typeof define&&define.amd?define(["exports","d3-queue","solarnetwork-api-core","d3-request"],t):t(e.sn=e.sn||{},e.d3,e.sn,e.d3)}(this,function(e,t,r,n){"use strict";function i(e){var t,n,i=0;for(i=0;i<e.length;i+=1)void 0!==(n=e[i]).data&&void 0!==n.data.endDate?(n=n.data,void 0===t?t=n:(n.endDateMillis>t.endDateMillis&&(t.endDateMillis=n.endDateMillis,t.endDate=n.endDate),n.startDateMillis<t.startDateMillis&&(t.startDateMillis=n.startDateMillis,t.startDate=n.startDate))):r.Logger.debug("No data available for %s sources %s",this._helpers[i].nodeId,this._helpers[i].sourceIds.join(","));return t}function a(e){if(!0===e.success&&void 0!==e.data&&!0===Array.isArray(e.data.results))return e.data.results}function o(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount:0}function l(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount+t.startingOffset:0}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},d=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),f=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},h=function(){function e(t){u(this,e),this.authBuilder=t,this.jsonClient=n.json}return d(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,n){e?r(e):t(n)})})}},{key:"load",value:function(e){e(new Error("Abstract method must be implemented by subclass."))}}]),e}(),v=function(e){function n(e,t){u(this,n);var i=c(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return Object.defineProperties(i,{version:{value:"1.0.0"}}),i._helpers=Array.isArray(e)?e:e?[e]:[new r.NodeDatumUrlHelper],i}return f(n,h),d(n,[{key:"load",value:function(e){var n=t.queue(),a=this.client(),o=this.authBuilder,l=!0,s=!1,u=void 0;try{for(var d,f=this._helpers[Symbol.iterator]();!(l=(d=f.next()).done);l=!0)!function(e){var t=e.reportableIntervalUrl(),i=a(t);o&&i.on("beforesend",function(e){o.reset().snDate(!0).url(t),e.setRequestHeader(r.HttpHeaders.X_SN_DATE,o.requestDateHeaderValue),e.setRequestHeader(r.HttpHeaders.AUTHORIZATION,o.buildWithSavedKey())}),n.defer(i.get,null)}(d.value)}catch(e){s=!0,u=e}finally{try{!l&&f.return&&f.return()}finally{if(s)throw u}}n.awaitAll(function(t,n){if(t)return r.Logger.error("Error requesting available data range: %s",t),void("function"==typeof e&&e(t));var a=i(n);void 0!==a.startDateMillis&&(a.sDate=new Date(a.startDateMillis)),void 0!==a.endDateMillis&&(a.eDate=new Date(a.endDateMillis)),"function"==typeof e&&e(null,a)})}}]),n}(),y=function(e){function n(e,t){u(this,n);var i=c(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return Object.defineProperties(i,{version:{value:"1.0.0"}}),i._helpers=Array.isArray(e)?e:e?[e]:[new r.NodeDatumUrlHelper],i}return f(n,h),d(n,[{key:"filter",value:function(e){return e?(e instanceof r.DatumFilter&&(this.datumFilter=e),this):this.datumFilter}},{key:"load",value:function(e){function n(e,t){l.push(e);var n=a(t);o&&n.on("beforesend",function(e){o.reset().snDate(!0).url(t),e.setRequestHeader(r.HttpHeaders.X_SN_DATE,o.requestDateHeaderValue),e.setRequestHeader(r.HttpHeaders.AUTHORIZATION,o.buildWithSavedKey())}),i.defer(n.get,null)}var i=t.queue(),a=this.client(),o=this.authBuilder,l=[],s=!0,u=!1,d=void 0;try{for(var f,c=this._helpers[Symbol.iterator]();!(s=(f=c.next()).done);s=!0){var h=f.value,v=new r.DatumFilter(this.datumFilter);if(v.nodeIds=h.nodeIds,v.metadataFilter||1===v.nodeIds.length)n(this.metadataFilter?null:v.nodeId,h.availableSourcesUrl(v));else{var y=!0,p=!1,b=void 0;try{for(var _,m=v.nodeIds[Symbol.iterator]();!(y=(_=m.next()).done);y=!0){var D=_.value,g=new r.DatumFilter(v);g.nodeId=D,n(D,h.availableSourcesUrl(g))}}catch(e){p=!0,b=e}finally{try{!y&&m.return&&m.return()}finally{if(p)throw b}}}}}catch(e){u=!0,d=e}finally{try{!s&&c.return&&c.return()}finally{if(u)throw d}}i.awaitAll(function(t,n){if(t)return r.Logger.error("Error requesting available sources: %s",t),void("function"==typeof e&&e(t));for(var i={},a=0,o=n.length;a<o;a+=1){var s=Array.isArray(n[a].data)?n[a].data:void 0;if(s){var u=l[a];if(null===u){var d=!0,f=!1,c=void 0;try{for(var h,v=s[Symbol.iterator]();!(d=(h=v.next()).done);d=!0){var y=h.value,p=i[y.nodeId];p||(p=[],i[y.nodeId]=p),p.indexOf(y.sourceId)<0&&p.push(y.sourceId)}}catch(e){f=!0,c=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw c}}}else{var b=i[u];if(b){var _=!0,m=!1,D=void 0;try{for(var g,w=s[Symbol.iterator]();!(_=(g=w.next()).done);_=!0){var k=g.value;b.indexOf(k)<0&&b.push(k)}}catch(e){m=!0,D=e}finally{try{!_&&w.return&&w.return()}finally{if(m)throw D}}}else i[u]=s}}}"function"==typeof e&&e(null,i)})}}]),n}(),p=function(e){function t(e,n,i){u(this,t);var a=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i));return Object.defineProperties(a,{version:{value:"1.0.0"}}),a.urlHelper=e||new r.NodeDatumUrlHelper,a.filter=n||new r.DatumFilter({nodeIds:a.urlHelper.nodeIds}),a._finishedCallback=void 0,a._urlParameters=void 0,a._incrementalMode=!1,a._state=0,a._results=void 0,a}return f(t,h),d(t,[{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}},{key:"parameters",value:function(e){return e?("object"===(void 0===e?"undefined":s(e))&&(this._urlParameters=e),this):this._urlParameters}},{key:"incremental",value:function(e){return void 0===e?this._incrementalMode:(this._incrementalMode=!!e,this)}},{key:"load",value:function(e){return"function"==typeof e&&(this._finishedCallback=e),this._state=1,this.loadData(),this}},{key:"handleResults",value:function(e,t,r){if(t&&(this._state=2),this._finishedCallback){var n=[e,this._results];this._incrementalMode&&(n.push(t),n.push(r)),this._finishedCallback.apply(this,n)}}},{key:"loadData",value:function(e){var t=this,n=e instanceof r.Pagination?e:new r.Pagination,i=this.urlHelper.listDatumUrl(this.filter,void 0,n);if(this._urlParameters){var s=r.urlQuery.urlQueryEncode(this._urlParameters);s&&(i+="&"+s)}var u=this.authBuilder;this.client()(i).on("beforesend",function(e){u&&(u.reset().snDate(!0).url(i),e.setRequestHeader(r.HttpHeaders.X_SN_DATE,u.requestDateHeaderValue),e.setRequestHeader(r.HttpHeaders.AUTHORIZATION,u.buildWithSavedKey()))}).on("load",function(e){var s=a(e);if(void 0===s)return r.Logger.debug("No data available for %s",i),void t.handleResults();var u=t._incrementalMode,d=l(e);if(void 0===t._results||u){if(t._results=s,n.max<1){var f=o(e);f>0&&(n=new r.Pagination(f,n.offset))}u&&t.handleResults(void 0,d<1,n)}else t._results=t._results.concat(s);d>0?t.loadData(n.withOffset(d)):u||t.handleResults(void 0,!0)}).on("error",function(e){r.Logger.error("Error requesting data for %s: %s",i,e),t.handleResults(new Error("Error requesting data for "+i+": "+e))}).get()}}]),t}(),b=function(){function e(t){u(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this._loaders=t,this._finishedCallback=void 0}return d(e,[{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,n){e?r(e):t(n)})})}},{key:"load",value:function(e){var r=this;"function"==typeof e&&(this._finishedCallback=e);var n=t.queue();return this._loaders.forEach(function(e){n.defer(e.load.bind(e))}),n.awaitAll(function(e,t){r._finishedCallback&&r._finishedCallback.call(r,e,t)}),this}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}}]),e}();e.DatumRangeFinder=v,e.DatumSourceFinder=y,e.DatumLoader=p,e.MultiLoader=b,Object.defineProperty(e,"__esModule",{value:!0})});