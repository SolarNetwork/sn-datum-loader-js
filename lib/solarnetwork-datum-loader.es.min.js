function extractReportableInterval(e){var t,r,a=0;for(a=0;a<e.length;a+=1)void 0!==(r=e[a]).data&&void 0!==r.data.endDate?(r=r.data,void 0===t?t=r:(r.endDateMillis>t.endDateMillis&&(t.endDateMillis=r.endDateMillis,t.endDate=r.endDate),r.startDateMillis<t.startDateMillis&&(t.startDateMillis=r.startDateMillis,t.startDate=r.startDate))):Logger.debug("No data available for %s sources %s",this._helpers[a].nodeId,this._helpers[a].sourceIds.join(","));return t}function datumExtractor(e){if(!0===e.success&&void 0!==e.data&&!0===Array.isArray(e.data.results))return e.data.results}function pageSizeExtractor(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount:0}function offsetExtractor(e,t){var r=e.data;return t&&t.max?r.returnedResultCount<t.max?0:r.startingOffset+t.max:r.returnedResultCount+r.startingOffset<r.totalResults?r.returnedResultCount+r.startingOffset:0}import{queue}from"d3-queue";import{DatumFilter,HttpHeaders,Logger,NodeDatumUrlHelper,Pagination,urlQuery}from"solarnetwork-api-core";import{json}from"d3-request";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},JsonClientSupport=function(){function e(t){classCallCheck(this,e),this.authBuilder=t,this.jsonClient=json}return createClass(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,a){e?r(e):t(a)})})}},{key:"load",value:function(e){e(new Error("Abstract method must be implemented by subclass."))}}]),e}(),DatumRangeFinder=function(e){function t(e,r){classCallCheck(this,t);var a=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r));return Object.defineProperties(a,{version:{value:"1.0.0"}}),a._helpers=Array.isArray(e)?e:e?[e]:[new NodeDatumUrlHelper],a}return inherits(t,JsonClientSupport),createClass(t,[{key:"load",value:function(e){var t=queue(),r=this.client(),a=this.authBuilder,n=!0,i=!1,o=void 0;try{for(var l,s=this._helpers[Symbol.iterator]();!(n=(l=s.next()).done);n=!0)!function(e){var n=e.reportableIntervalUrl(),i=r(n).on("beforesend",function(e){a&&a.signingKeyValid&&(a.reset().snDate(!0).url(n),e.setRequestHeader(HttpHeaders.X_SN_DATE,a.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,a.buildWithSavedKey()))});t.defer(i.get,null)}(l.value)}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}t.awaitAll(function(t,r){if(t)return Logger.error("Error requesting available data range: %s",t),void("function"==typeof e&&e(t));var a=extractReportableInterval(r);void 0!==a.startDateMillis&&(a.sDate=new Date(a.startDateMillis)),void 0!==a.endDateMillis&&(a.eDate=new Date(a.endDateMillis)),"function"==typeof e&&e(null,a)})}}]),t}(),DatumSourceFinder=function(e){function t(e,r){classCallCheck(this,t);var a=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r));return Object.defineProperties(a,{version:{value:"1.0.0"}}),a._helpers=Array.isArray(e)?e:e?[e]:[new NodeDatumUrlHelper],a}return inherits(t,JsonClientSupport),createClass(t,[{key:"filter",value:function(e){return e?(e instanceof DatumFilter&&(this.datumFilter=e),this):this.datumFilter}},{key:"load",value:function(e){function t(e,t){i.push(e);var o=a(t).on("beforesend",function(e){n&&n.signingKeyValid&&(n.reset().snDate(!0).url(t),e.setRequestHeader(HttpHeaders.X_SN_DATE,n.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,n.buildWithSavedKey()))});r.defer(o.get,null)}var r=queue(),a=this.client(),n=this.authBuilder,i=[],o=!0,l=!1,s=void 0;try{for(var u,d=this._helpers[Symbol.iterator]();!(o=(u=d.next()).done);o=!0){var f=u.value,c=new DatumFilter(this.datumFilter);if(c.nodeIds=f.nodeIds,c.metadataFilter||1===c.nodeIds.length)t(this.metadataFilter?null:c.nodeId,f.availableSourcesUrl(c));else{var h=!0,v=!1,p=void 0;try{for(var y,b=c.nodeIds[Symbol.iterator]();!(h=(y=b.next()).done);h=!0){var _=y.value,m=new DatumFilter(c);m.nodeId=_,t(_,f.availableSourcesUrl(m))}}catch(e){v=!0,p=e}finally{try{!h&&b.return&&b.return()}finally{if(v)throw p}}}}}catch(e){l=!0,s=e}finally{try{!o&&d.return&&d.return()}finally{if(l)throw s}}r.awaitAll(function(t,r){if(t)return Logger.error("Error requesting available sources: %s",t),void("function"==typeof e&&e(t));for(var a={},n=0,o=r.length;n<o;n+=1){var l=Array.isArray(r[n].data)?r[n].data:void 0;if(l){var s=i[n];if(null===s){var u=!0,d=!1,f=void 0;try{for(var c,h=l[Symbol.iterator]();!(u=(c=h.next()).done);u=!0){var v=c.value,p=a[v.nodeId];p||(p=[],a[v.nodeId]=p),p.indexOf(v.sourceId)<0&&p.push(v.sourceId)}}catch(e){d=!0,f=e}finally{try{!u&&h.return&&h.return()}finally{if(d)throw f}}}else{var y=a[s];if(y){var b=!0,_=!1,m=void 0;try{for(var g,C=l[Symbol.iterator]();!(b=(g=C.next()).done);b=!0){var D=g.value;y.indexOf(D)<0&&y.push(D)}}catch(e){_=!0,m=e}finally{try{!b&&C.return&&C.return()}finally{if(_)throw m}}}else a[s]=l}}}"function"==typeof e&&e(null,a)})}}]),t}(),DatumLoader=function(e){function t(e,r,a){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,a));return Object.defineProperties(n,{version:{value:"1.0.0"}}),n.urlHelper=e||new NodeDatumUrlHelper,a||(e.publicQuery=!0),n.filter=r||new DatumFilter({nodeIds:n.urlHelper.nodeIds,withoutTotalResultsCount:!0}),n._pageSize=1e3,n._includeTotalResultsCount=!1,n._finishedCallback=void 0,n._urlParameters=void 0,n._incrementalMode=!1,n._state=0,n._results=void 0,n}return inherits(t,JsonClientSupport),createClass(t,[{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}},{key:"parameters",value:function(e){return e?("object"===(void 0===e?"undefined":_typeof(e))&&(this._urlParameters=e),this):this._urlParameters}},{key:"incremental",value:function(e){return void 0===e?this._incrementalMode:(this._incrementalMode=!!e,this)}},{key:"paginationSize",value:function(e){return isNaN(Number(e))?this._pageSize:(this._pageSize=e,this)}},{key:"includeTotalResultsCount",value:function(e){return void 0===e?this._includeTotalResultsCount:(this._includeTotalResultsCount=!!e,this)}},{key:"load",value:function(e){return"function"==typeof e&&(this._finishedCallback=e),this._state=1,this.loadData(new Pagination(this._pageSize,0)),this}},{key:"handleResults",value:function(e,t,r){if(t&&(this._state=2),this._finishedCallback){var a=[e,this._results];this._incrementalMode&&(a.push(t),a.push(r)),this._finishedCallback.apply(this,a)}}},{key:"loadData",value:function(e){var t=this,r=this.authBuilder,a=e instanceof Pagination?e:new Pagination,n=new DatumFilter(this.filter);n.withoutTotalResultsCount=!this._includeTotalResultsCount||0!==a.offset;var i=this.urlHelper.listDatumUrl(n,void 0,a);if(this._urlParameters){var o=urlQuery.urlQueryEncode(this._urlParameters);o&&(i+="&"+o)}this.client()(i).on("beforesend",function(e){r&&r.signingKeyValid&&(r.reset().snDate(!0).url(i),e.setRequestHeader(HttpHeaders.X_SN_DATE,r.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,r.buildWithSavedKey()))}).on("load",function(e){var r=datumExtractor(e);if(void 0===r)return Logger.debug("No data available for %s",i),void t.handleResults();var n=t._incrementalMode,o=offsetExtractor(e,a);if(void 0===t._results||n){if(t._results=r,a.max<1){var l=pageSizeExtractor(e);l>0&&(a=new Pagination(l,a.offset))}n&&t.handleResults(void 0,o<1,a)}else t._results=t._results.concat(r);o>0?t.loadData(a.withOffset(o)):n||t.handleResults(void 0,!0)}).on("error",function(e){Logger.error("Error requesting data for %s: %s",i,e),t.handleResults(new Error("Error requesting data for "+i+": "+e))}).get()}}]),t}(),MultiLoader=function(){function e(t){classCallCheck(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this._loaders=t,this._finishedCallback=void 0}return createClass(e,[{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,a){e?r(e):t(a)})})}},{key:"load",value:function(e){var t=this;"function"==typeof e&&(this._finishedCallback=e);var r=queue();return this._loaders.forEach(function(e){r.defer(e.load.bind(e))}),r.awaitAll(function(e,r){t._finishedCallback&&t._finishedCallback.call(t,e,r)}),this}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}}]),e}();export{DatumRangeFinder,DatumSourceFinder,DatumLoader,MultiLoader};