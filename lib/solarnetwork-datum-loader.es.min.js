function datumExtractor(t){if(!0===t.success&&void 0!==t.data&&!0===Array.isArray(t.data.results))return t.data.results}function pageSizeExtractor(t){var e=t.data;return e.returnedResultCount+e.startingOffset<e.totalResults?e.returnedResultCount:0}function offsetExtractor(t){var e=t.data;return e.returnedResultCount+e.startingOffset<e.totalResults?e.returnedResultCount+e.startingOffset:0}import{json}from"d3-request";import{DatumFilter,HttpHeaders,Logger,NodeDatumUrlHelper,Pagination,urlQuery}from"solarnetwork-api-core";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,r,a){return r&&t(e.prototype,r),a&&t(e,a),e}}(),DatumLoader=function(){function t(e,r,a){classCallCheck(this,t),this.urlHelper=e||new NodeDatumUrlHelper,this.filter=r||new DatumFilter({nodeIds:this.urlHelper.nodeIds}),this.authBuilder=a,this._finishedCallback=void 0,this._urlParameters=void 0,this.jsonClient=json,this._incrementalMode=!1,this._state=0,this._results=void 0}return createClass(t,[{key:"client",value:function(t){return t?("function"==typeof t&&(this.jsonClient=t),this):this.jsonClient}},{key:"callback",value:function(t){return t?("function"==typeof t&&(this._finishedCallback=t),this):this._finishedCallback}},{key:"parameters",value:function(t){return t?("object"===(void 0===t?"undefined":_typeof(t))&&(this._urlParameters=t),this):this._urlParameters}},{key:"incremental",value:function(t){return void 0===t?this._incrementalMode:(this._incrementalMode=!!t,this)}},{key:"load",value:function(t){return"function"==typeof t&&(this._finishedCallback=t),this._state=1,this.loadData(),this}},{key:"handleResults",value:function(t,e,r){if(e&&(this._state=2),this._finishedCallback){var a=[t,this._results];this._incrementalMode&&(a.push(e),a.push(r)),this._finishedCallback.apply(this,a)}}},{key:"loadData",value:function(t){var e=this,r=t instanceof Pagination?t:new Pagination,a=this.urlHelper.listDatumUrl(this.filter,void 0,r);if(this._urlParameters){var n=urlQuery.urlQueryEncode(this._urlParameters);n&&(a+="&"+n)}var s=this.authBuilder;this.jsonClient(a).on("beforesend",function(t){s&&(s.reset().snDate(!0).url(a),t.setRequestHeader(HttpHeaders.X_SN_DATE,s.requestDateHeaderValue),t.setRequestHeader(HttpHeaders.AUTHORIZATION,s.buildWithSavedKey()))}).on("load",function(t){var n=datumExtractor(t);if(void 0===n)return Logger.debug("No data available for %s",a),void e.handleResults();var s=e._incrementalMode,i=offsetExtractor(t);if(void 0===e._results||s){if(e._results=n,r.max<1){var o=pageSizeExtractor(t);o>0&&(r=new Pagination(o,r.offset))}s&&e.handleResults(void 0,i<1,r)}else e._results=e._results.concat(n);i>0?e.loadData(r.withOffset(i)):s||e.handleResults(void 0,!0)}).on("error",function(t){Logger.error("Error requesting data for %s: %s",a,t),e.handleResults(new Error("Error requesting data for "+a+": "+t))}).get()}}]),t}();export{DatumLoader};