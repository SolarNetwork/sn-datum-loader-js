function extractReportableInterval(e){var t,r,a=0;for(a=0;a<e.length;a+=1)void 0!==(r=e[a]).data&&void 0!==r.data.endDate?(r=r.data,void 0===t?t=r:(r.endDateMillis>t.endDateMillis&&(t.endDateMillis=r.endDateMillis,t.endDate=r.endDate),r.startDateMillis<t.startDateMillis&&(t.startDateMillis=r.startDateMillis,t.startDate=r.startDate))):Logger.debug("No data available for %s sources %s",this._helpers[a].nodeId,this._helpers[a].sourceIds.join(","));return t}function datumExtractor(e){if(!0===e.success&&void 0!==e.data&&!0===Array.isArray(e.data.results))return e.data.results}function pageSizeExtractor(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount:0}function offsetExtractor(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount+t.startingOffset:0}import{json}from"d3-request";import{queue}from"d3-queue";import{DatumFilter,HttpHeaders,Logger,NodeDatumUrlHelper,Pagination,urlQuery}from"solarnetwork-api-core";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),DatumRangeFinder=function(){function e(t,r){classCallCheck(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this._helpers=Array.isArray(t)?t:t?[t]:[new NodeDatumUrlHelper],this.authBuilder=r,this.jsonClient=json}return createClass(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"do",value:function(){var e=this;return new Promise(function(t,r){e.exec(function(e,a){e?r(e):t(a)})})}},{key:"exec",value:function(e){var t=queue(),r=this.jsonClient,a=this.authBuilder,i=!0,n=!1,s=void 0;try{for(var l,o=this._helpers[Symbol.iterator]();!(i=(l=o.next()).done);i=!0)!function(e){var i=e.reportableIntervalUrl(),n=r(i);a&&n.on("beforesend",function(e){a.reset().snDate(!0).url(i),e.setRequestHeader(HttpHeaders.X_SN_DATE,a.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,a.buildWithSavedKey())}),t.defer(n.get,null)}(l.value)}catch(e){n=!0,s=e}finally{try{!i&&o.return&&o.return()}finally{if(n)throw s}}t.awaitAll(function(t,r){if(t)return Logger.error("Error requesting available data range: %s",t),void("function"==typeof e&&e(t));var a=extractReportableInterval(r);void 0!==a.startDateMillis&&(a.sDate=new Date(a.startDateMillis)),void 0!==a.endDateMillis&&(a.eDate=new Date(a.endDateMillis)),"function"==typeof e&&e(null,a)})}}]),e}(),DatumLoader=function(){function e(t,r,a){classCallCheck(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this.urlHelper=t||new NodeDatumUrlHelper,this.filter=r||new DatumFilter({nodeIds:this.urlHelper.nodeIds}),this.authBuilder=a,this._finishedCallback=void 0,this._urlParameters=void 0,this.jsonClient=json,this._incrementalMode=!1,this._state=0,this._results=void 0}return createClass(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}},{key:"parameters",value:function(e){return e?("object"===(void 0===e?"undefined":_typeof(e))&&(this._urlParameters=e),this):this._urlParameters}},{key:"incremental",value:function(e){return void 0===e?this._incrementalMode:(this._incrementalMode=!!e,this)}},{key:"load",value:function(e){return"function"==typeof e&&(this._finishedCallback=e),this._state=1,this.loadData(),this}},{key:"handleResults",value:function(e,t,r){if(t&&(this._state=2),this._finishedCallback){var a=[e,this._results];this._incrementalMode&&(a.push(t),a.push(r)),this._finishedCallback.apply(this,a)}}},{key:"loadData",value:function(e){var t=this,r=e instanceof Pagination?e:new Pagination,a=this.urlHelper.listDatumUrl(this.filter,void 0,r);if(this._urlParameters){var i=urlQuery.urlQueryEncode(this._urlParameters);i&&(a+="&"+i)}var n=this.authBuilder;this.jsonClient(a).on("beforesend",function(e){n&&(n.reset().snDate(!0).url(a),e.setRequestHeader(HttpHeaders.X_SN_DATE,n.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,n.buildWithSavedKey()))}).on("load",function(e){var i=datumExtractor(e);if(void 0===i)return Logger.debug("No data available for %s",a),void t.handleResults();var n=t._incrementalMode,s=offsetExtractor(e);if(void 0===t._results||n){if(t._results=i,r.max<1){var l=pageSizeExtractor(e);l>0&&(r=new Pagination(l,r.offset))}n&&t.handleResults(void 0,s<1,r)}else t._results=t._results.concat(i);s>0?t.loadData(r.withOffset(s)):n||t.handleResults(void 0,!0)}).on("error",function(e){Logger.error("Error requesting data for %s: %s",a,e),t.handleResults(new Error("Error requesting data for "+a+": "+e))}).get()}}]),e}(),MultiLoader=function(){function e(t){classCallCheck(this,e),Object.defineProperties(this,{version:{value:"1.0.0"}}),this._loaders=t,this._finishedCallback=void 0}return createClass(e,[{key:"load",value:function(e){var t=this;"function"==typeof e&&(this._finishedCallback=e);var r=queue();return this._loaders.forEach(function(e){r.defer(function(t){e.load(t)})}),r.awaitAll(function(e,r){t._finishedCallback&&t._finishedCallback.call(t,e,r)}),this}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}}]),e}();export{DatumRangeFinder,DatumLoader,MultiLoader};