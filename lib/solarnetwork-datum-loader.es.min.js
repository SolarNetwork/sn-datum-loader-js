function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function extractReportableInterval(e){var t,r,n=0;for(n=0;n<e.length;n+=1)void 0!==(r=e[n]).data&&void 0!==r.data.endDate?(r=r.data,void 0===t?t=r:(r.endDateMillis>t.endDateMillis&&(t.endDateMillis=r.endDateMillis,t.endDate=r.endDate),r.startDateMillis<t.startDateMillis&&(t.startDateMillis=r.startDateMillis,t.startDate=r.startDate))):Logger.debug("No data available for %s sources %s",this._helpers[n].nodeId,this._helpers[n].sourceIds.join(","));return t}function datumExtractor(e){if(!0===e.success&&void 0!==e.data&&!0===Array.isArray(e.data.results))return e.data.results}function pageSizeExtractor(e){var t=e.data;return t.returnedResultCount+t.startingOffset<t.totalResults?t.returnedResultCount:0}function offsetExtractor(e,t){var r=e.data;return t&&t.max?r.returnedResultCount<t.max?0:r.startingOffset+t.max:r.returnedResultCount+r.startingOffset<r.totalResults?r.returnedResultCount+r.startingOffset:0}import{queue}from"d3-queue";import{NodeDatumUrlHelper,HttpHeaders,Logger,DatumFilter,Pagination,DatumReadingTypes,urlQuery}from"solarnetwork-api-core";import{json}from"d3-request";var JsonClientSupport=function(){function e(t){_classCallCheck(this,e),this.authBuilder=t,this.jsonClient=json}return _createClass(e,[{key:"client",value:function(e){return e?("function"==typeof e&&(this.jsonClient=e),this):this.jsonClient}},{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,n){e?r(e):t(n)})})}},{key:"load",value:function(e){e(new Error("Abstract method must be implemented by subclass."))}}]),e}(),DatumRangeFinder=function(e){function t(e,r){var n;return _classCallCheck(this,t),n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,r)),Object.defineProperties(_assertThisInitialized(n),{version:{value:"1.0.0"}}),n._helpers=Array.isArray(e)?e:e?[e]:[new NodeDatumUrlHelper],n}return _inherits(t,JsonClientSupport),_createClass(t,[{key:"load",value:function(e){var t=queue(),r=this.client(),n=this.authBuilder,i=!0,a=!1,o=void 0;try{for(var s,l=function(){var e=s.value.reportableIntervalUrl(),i=r(e).on("beforesend",function(t){n&&n.signingKeyValid&&(n.reset().snDate(!0).url(e,!0),t.setRequestHeader(HttpHeaders.X_SN_DATE,n.requestDateHeaderValue),t.setRequestHeader(HttpHeaders.AUTHORIZATION,n.buildWithSavedKey()))});t.defer(i.get,null)},u=this._helpers[Symbol.iterator]();!(i=(s=u.next()).done);i=!0)l()}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}t.awaitAll(function(t,r){if(t)return Logger.error("Error requesting available data range: %s",t),void("function"==typeof e&&e(t));var n=extractReportableInterval(r);void 0!==n.startDateMillis&&(n.sDate=new Date(n.startDateMillis)),void 0!==n.endDateMillis&&(n.eDate=new Date(n.endDateMillis)),"function"==typeof e&&e(null,n)})}}]),t}(),DatumSourceFinder=function(e){function t(e,r){var n;return _classCallCheck(this,t),n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,r)),Object.defineProperties(_assertThisInitialized(n),{version:{value:"1.0.0"}}),n._helpers=Array.isArray(e)?e:e?[e]:[new NodeDatumUrlHelper],n}return _inherits(t,JsonClientSupport),_createClass(t,[{key:"filter",value:function(e){return e?(e instanceof DatumFilter&&(this.datumFilter=e),this):this.datumFilter}},{key:"load",value:function(e){function t(e,t){a.push(e);var o=n(t).on("beforesend",function(e){i&&i.signingKeyValid&&(i.reset().snDate(!0).url(t,!0),e.setRequestHeader(HttpHeaders.X_SN_DATE,i.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,i.buildWithSavedKey()))});r.defer(o.get,null)}var r=queue(),n=this.client(),i=this.authBuilder,a=[],o=!0,s=!1,l=void 0;try{for(var u,c=this._helpers[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var d=u.value,f=new DatumFilter(this.datumFilter);if(f.nodeIds=d.nodeIds,f.metadataFilter||1===f.nodeIds.length)t(this.metadataFilter?null:f.nodeId,d.availableSourcesUrl(f));else{var h=!0,y=!1,v=void 0;try{for(var _,p=f.nodeIds[Symbol.iterator]();!(h=(_=p.next()).done);h=!0){var b=_.value,m=new DatumFilter(f);m.nodeId=b,t(b,d.availableSourcesUrl(m))}}catch(e){y=!0,v=e}finally{try{h||null==p.return||p.return()}finally{if(y)throw v}}}}}catch(e){s=!0,l=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw l}}r.awaitAll(function(t,r){if(t)return Logger.error("Error requesting available sources: %s",t),void("function"==typeof e&&e(t));for(var n={},i=0,o=r.length;i<o;i+=1){var s=Array.isArray(r[i].data)?r[i].data:void 0;if(s){var l=a[i];if(null===l){var u=!0,c=!1,d=void 0;try{for(var f,h=s[Symbol.iterator]();!(u=(f=h.next()).done);u=!0){var y=f.value,v=n[y.nodeId];v||(v=[],n[y.nodeId]=v),v.indexOf(y.sourceId)<0&&v.push(y.sourceId)}}catch(e){c=!0,d=e}finally{try{u||null==h.return||h.return()}finally{if(c)throw d}}}else{var _=n[l];if(_){var p=!0,b=!1,m=void 0;try{for(var g,C=s[Symbol.iterator]();!(p=(g=C.next()).done);p=!0){var D=g.value;_.indexOf(D)<0&&_.push(D)}}catch(e){b=!0,m=e}finally{try{p||null==C.return||C.return()}finally{if(b)throw m}}}else n[l]=s}}}"function"==typeof e&&e(null,n)})}}]),t}(),DatumLoader=function(e){function t(e,r,n){var i;return _classCallCheck(this,t),i=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,n)),Object.defineProperties(_assertThisInitialized(i),{version:{value:"1.2.0"}}),i.urlHelper=e||new NodeDatumUrlHelper,n||(e.publicQuery=!0),i.filter=r||new DatumFilter({nodeIds:i.urlHelper.nodeIds,withoutTotalResultsCount:!0}),i._pageSize=1e3,i._includeTotalResultsCount=!1,i._finishedCallback=void 0,i._urlParameters=void 0,i._incrementalMode=!1,i._readingsMode=!1,i._proxyUrl=void 0,i._concurrency=0,i._queue=null,i._state=0,i._results=void 0,i}return _inherits(t,JsonClientSupport),_createClass(t,[{key:"concurrency",value:function(e){return void 0===e?this._concurrency:(!isNaN(e)&&Number(e)>0&&(this._concurrency=Number(e)),this)}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}},{key:"parameters",value:function(e){return e?("object"===_typeof(e)&&(this._urlParameters=e),this):this._urlParameters}},{key:"incremental",value:function(e){return void 0===e?this._incrementalMode:(this._incrementalMode=!!e,this)}},{key:"paginationSize",value:function(e){return isNaN(Number(e))?this._pageSize:(this._pageSize=e,this)}},{key:"includeTotalResultsCount",value:function(e){return void 0===e?this._includeTotalResultsCount:(this._includeTotalResultsCount=!!e,this)}},{key:"readings",value:function(e){return void 0===e?this._readingsMode:(this._readingsMode=!!e,this)}},{key:"proxyUrl",value:function(e){return void 0===e?this._proxyUrl:(this._proxyUrl=e||void 0,this)}},{key:"load",value:function(e){return"function"==typeof e&&(this._finishedCallback=e),this._state=1,this._concurrency>0&&(this._queue=queue(this._concurrency===1/0?null:this._concurrency)),this.loadData(new Pagination(this._pageSize,0)),this}},{key:"handleResults",value:function(e,t,r){if(t&&(this._state=2),this._finishedCallback){var n=[e,this._results];this._incrementalMode&&(n.push(t),n.push(r)),this._finishedCallback.apply(this,n)}}},{key:"loadData",value:function(e){var t=this,r=this.authBuilder,n=this._queue,i=e instanceof Pagination?e:new Pagination,a=new DatumFilter(this.filter);a.withoutTotalResultsCount=!this._includeTotalResultsCount&&!n||0!==i.offset;var o=this._readingsMode?this.urlHelper.datumReadingUrl(a,DatumReadingTypes.Difference,void 0,void 0,i):this.urlHelper.listDatumUrl(a,void 0,i);if(this._urlParameters){var s=urlQuery.urlQueryEncode(this._urlParameters);s&&(o+="&"+s)}var l=this._proxyUrl?o.replace(/^[^:]+:\/\/[^/]+/,this._proxyUrl):o,u=this.client()(l).on("beforesend",function(e){r&&r.signingKeyValid&&(r.reset().snDate(!0).url(o,!0),e.setRequestHeader(HttpHeaders.X_SN_DATE,r.requestDateHeaderValue),e.setRequestHeader(HttpHeaders.AUTHORIZATION,r.buildWithSavedKey()))}).on("load",function(e){var r=datumExtractor(e);if(void 0===r)return Logger.debug("No data available for %s",l),void t.handleResults();var a=t._incrementalMode,o=offsetExtractor(e,i),s=e.data?e.data.totalResults:null;if(void 0===t._results||a){if(t._results=r,i.max<1){var u=pageSizeExtractor(e);u>0&&(i=new Pagination(u,i.offset))}a&&t.handleResults(void 0,o<1,i)}else n||(t._results=t._results.concat(r));if(o>0||n&&i.offset>0)if(n){if(s>0){for(var c=o;c<s;c+=i.max)t.loadData(i.withOffset(c));n.awaitAll(function(e,r){e||r.map(function(e){return datumExtractor(e)||[]}).forEach(function(e){t._results=t._results.concat(e)}),t.handleResults(null!==e?e:void 0,!0)})}}else t.loadData(i.withOffset(o));else a||t.handleResults(void 0,!0)}).on("error",function(e){Logger.error("Error requesting data for %s: %s",l,e),t.handleResults(new Error("Error requesting data for ".concat(l,": ").concat(e)))});n&&i.offset>0?n.defer(u.get,null):u.get()}}]),t}(),MultiLoader=function(){function e(t){_classCallCheck(this,e),Object.defineProperties(this,{version:{value:"1.1.0"}}),this._loaders=t,this._finishedCallback=void 0,this._concurrency=1/0}return _createClass(e,[{key:"concurrency",value:function(e){if(void 0===e)return this._concurrency;var t=Number(e);return!isNaN(e)&&t>0&&(this._concurrency=t),this}},{key:"fetch",value:function(){var e=this;return new Promise(function(t,r){e.load(function(e,n){e?r(e):t(n)})})}},{key:"load",value:function(e){var t=this;"function"==typeof e&&(this._finishedCallback=e);var r=queue(this._concurrency);return this._loaders.forEach(function(e){r.defer(e.load.bind(e))}),r.awaitAll(function(e,r){t._finishedCallback&&t._finishedCallback.call(t,e,r)}),this}},{key:"callback",value:function(e){return e?("function"==typeof e&&(this._finishedCallback=e),this):this._finishedCallback}}]),e}();export{DatumLoader,DatumRangeFinder,DatumSourceFinder,MultiLoader};